var cbuilder={};!function(){var t={setObjVariable:function(t,e,n){if(void 0!=e&&"string"==typeof e){e=e.split(",");for(var i=0;i<e.length;i++){var a=e[i];n&&(a=a.replace(n,""));var o="#";e[i].indexOf(".")>=0&&(a=a.replace(/\./gi,""),o=""),t["$"+a]=$(o+e[i])}}},stringToDate:function(t){if(t&&t.indexOf("-")>=4&&t.indexOf(":")>=13){var e=t.split(" ")[0].split("-"),n=t.split(" ")[1].split(":");return new Date(e[0],e[1]-1,e[2],null!==n[0]?n[0]:0,null!==n[1]?n[1]:0,null!==n[2]?n[2]:0)}return/^\d+$/.test(t)?(10===t.length&&(t+="000"),new Date(parseInt(t,10))):void 0},objectCallFunction:function(t){for(var e,n=1;n<arguments.length;n++)e=t[arguments[n]],"function"==typeof e&&e()},ajaxData:function(t,e){var n={type:"post"},i=$.extend({},n,t);$.ajax({url:i.url,data:i.data,type:i.type,success:function(t){"function"==typeof e&&e($.parseJSON(t))}})}},e={init:function(){var t=$("img"),n=t.length,i=0;t.one("load",function(){++i===n&&e._parseComponents()}).each(function(){this.complete&&$(this).load()})},_parseComponents:function(){for(var t in cbuilder){var e=cbuilder[t];if("parse"===t)return!1;"function"==typeof e&&e()}}};cbuilder.picture=function(){var e,n="img",i=function(t){this.element=t};i.prototype={start:function(){function t(){var e=1e3*n.data("time"),c="",d=n.startdate,s=n.enddate,l=n.isdayunit,u=0;d>e&&s>e||d>e&&void 0==s?(c="距离开始时间还有:",u=d-e):(void 0==d&&s>=e||s>=e)&&(c="距离结束时间还有:",u=s-e);var f,p,h,m,v,g=function(){"undefined"!=typeof n.cdtimeout&&clearTimeout(n.cdtimeout),n.remove()};if(u>=0){f=Math.floor(u/864e5),u-=864e5*f,p=Math.floor(u/36e5),u-=36e5*p,h=Math.floor(u/6e4),u-=6e4*h,m=Math.floor(u/1e3),10>p&&(p="0"+p),10>h&&(h="0"+h),10>m&&(m="0"+m),v=parseInt(p)+24*f,"cn"===n.format?(i.html(f>0&&"true"===l&&v>=24?f+"天"+p+"时":v+"时"),o.html(c),a.html(h+"分"),r.html(m+"秒")):"HH:mm:ss"===n.format&&(i.html(f>0&&"true"===l&&v>=24?f+"天"+p+":":v+":"),o.html(c),a.html(h+":"),r.html(m)),0===f&&"00"===p&&"00"===h&&"00"===m&&g();var w=n.data("time")+1;n.data("time",w),n.cdtimeout=setTimeout(t,1e3)}else g()}this.init(),this.appendHtml();var n=this.element;n.data("time",e);var i=n.find(".cdh"),a=n.find(".cdm"),o=n.find(".cdtip"),r=n.find(".cds");t()},init:function(){var e=this.element,n=e.attr("startdate"),i=e.attr("enddate");void 0!=n&&(n=new Date(t.stringToDate(n+":00"))),void 0!=i&&(i=new Date(t.stringToDate(i+":00"))),e.format=e.attr("format")||"cn",e.startdate=n,e.enddate=i,e.isdayunit=e.attr("isdayunit"),e.removeAttr("startdate").removeAttr("enddate").removeAttr("isdayunit").removeAttr("format")},appendHtml:function(){var t="",e=this.element;t+="<span class='cdtip'></span>",t+="<span class='cdh'></span>",t+="<span class='cdm'></span>",t+="<span class='cds'></span>",e.html(t)}};var a={_domCache:function(){t.setObjVariable(a,".cb-cropwrap","cb-"),a.$imgpos=a.$cropwrap.find(".imgpos"),e=t.stringToDate($("div[data-nowtime]").data("nowtime"))/1e3||(new Date).getTime()/1e3},_pictureComponent:function(){var o=[],r=[],c=[/goods_id=\d+/,/\d+.html/gi,/goods-\d+/],d={checkIconState:function(){a.$imgpos.each(function(t){var e=$(this),n=e.attr("href");if(n&&n.indexOf("item.shenba.com")>=0){for(var i=0;i<c.length;i++)c[i].test(n)&&(n=n.toString(),n=n.match(c[i]));null!=n&&(n=n.toString().match(/\d+/),void 0==e.attr("linkicon")&&null!=n&&o.push(n))}t===a.$imgpos.length-1&&d.showStateIcon()})},checkCountDownState:function(){var o=!1;a.$cropwrap.each(function(){var a=1e3*e,r=$(this),c=t.stringToDate(r.attr("showdate")+":00"),d=t.stringToDate(r.attr("hidedate")+":00");if(void 0===c&&void 0===d?o=!0:(void 0!=c&&void 0===d&&new Date(c)<a&&(o=!0),void 0!=d&&void 0===c&&a<new Date(d)&&(o=!0),void 0!=c&&void 0!=d&&(o=new Date(c)<a&&a<new Date(d))),o){r.find(n).show();var s=r.find(".imgpos[linktype='countdown']");s.each(function(){var t=new i($(this));t.start(),$(this).removeAttr("linktype")})}else r.hide(),r.find(n).hide()})},showStateIcon:function(){if(0===o.length)return!1;var e={url:"/index.php?act=index&op=getgoods_storage",data:{client:"pc",goods_id:o.toString()}};return t.ajaxData(e,function(t){var e=t;if(void 0!=e.data){var n=e.data;if(1===n.status&&void 0!=n.list){var i=n.list,a=0,o=0;for(a=0,o=i.length;o>a;a++)i[a].goods_storage<=0&&""!==i[a].goods_id&&r.push(i[a].goods_id);for(a=0,o=r.length;o>a;a++)$(".imgpos").each(function(){var t=$(this),e=t.attr("href"),n="";if(e)for(var i=0;i<c.length;i++)n=e.toString().match(/\d+/),n&&n[0]===r[a]&&t.children("b").css("display","block")})}}}),!1},init:function(){t.objectCallFunction(d,"checkIconState","checkCountDownState")}};d.init()},struc:function(){t.objectCallFunction(a,"_domCache","_pictureComponent")}};a.struc()},cbuilder.parse=function(t){t&&(cbuilder.selector=t),$(document).ready(function(){e.init()})}}();